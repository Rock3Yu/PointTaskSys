<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
  <title>ä¸ªäººç§¯åˆ†ä»»åŠ¡ç³»ç»Ÿ</title>

  <style>
    html {
      font-size: 18px;
    }

    @media (max-width: 480px) {
      html {
        font-size: 30px;
      }
    }

    /* ---------- åŸºç¡€ ---------- */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #e5fcef;
      color: #1f2937;
      margin: 0;
      padding: 16px;
      line-height: 1.6;
    }

    h1,
    h2,
    h3 {
      margin-top: 24px;
      margin-bottom: 12px;
      color: #0f4c81;
    }

    h1 {
      font-size: 1.6rem;
      text-align: center;
    }

    h2 {
      font-size: 1.25rem;
    }

    h3 {
      font-size: 1.1rem;
    }

    hr {
      border: none;
      border-top: 1px solid #dbeafe;
      margin: 20px 0;
    }

    /* ---------- ä¿¡æ¯æç¤º ---------- */
    #currentTime,
    #lastSync,
    #storageHint,
    #todayStats {
      font-size: 0.95rem;
      color: #2563eb;
      margin-top: 6px;
    }

    #storageHint {
      font-size: 0.85rem;
      color: #64748b;
    }

    /* ---------- è¾“å…¥ ---------- */
    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      margin-bottom: 10px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #c7d2fe;
      box-sizing: border-box;
    }

    input[type="radio"] {
      transform: scale(1.2);
      margin-right: 4px;
    }

    label {
      margin-right: 12px;
    }

    /* ---------- æŒ‰é’® ---------- */
    button {
      padding: 8px 14px;
      margin: 6px 4px 6px 0;
      font-size: 0.95rem;
      border-radius: 8px;
      border: none;
      background: #3b82f6;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background: #2563eb;
    }

    button:active {
      transform: scale(0.97);
    }

    /* ---------- åˆ—è¡¨å¡ç‰‡ ---------- */
    #taskList>div,
    #costList>div {
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    /* ---------- å·²å®Œæˆä»»åŠ¡ ---------- */
    #todayCompleted li {
      background: #e0f2fe;
      padding: 6px 10px;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 0.9rem;
    }

    /* ---------- æ¶ˆè€—è®°å½• ---------- */
    #costLog li {
      font-size: 0.9rem;
      color: #475569;
      margin-bottom: 6px;
    }

    /* ---------- å“åº”å¼ ---------- */
    @media (min-width: 768px) {
      body {
        max-width: 700px;
        margin: auto;
        padding: 24px;
      }
    }

    /* ---------- åˆ›å»ºåŒºåŸŸè¾“å…¥è¡Œä¼˜åŒ– ---------- */
    h2+label,
    h2+input {
      display: inline-block;
    }

    /* æ ‡é¢˜è¾“å…¥æ¡†æ›´é•¿ */
    /* #taskTitle,
    #costTitle {
      width: 80%;
    }
      */

    /* ç§¯åˆ†è¡Œï¼šæ–‡å­— + è¾“å…¥åœ¨åŒä¸€è¡Œ */
    #taskPoints,
    #costPoints {
      width: 120px;
      display: inline-block;
      margin-left: 8px;
    }

    /* ç§¯åˆ†æ‰€åœ¨è¡Œæ•´ä½“ä¸è¦æ’‘æ»¡ */
    #taskPoints,
    #costPoints {
      margin-bottom: 6px;
    }

    /* ---------- ç»Ÿä¸€è¾“å…¥æ¡†é«˜åº¦ ---------- */
    input[type="text"],
    input[type="number"] {
      height: 44px;
      line-height: 44px;
      padding: 0 12px;
    }

    /* å¡ç‰‡å†…å®¹å·¦å³å¸ƒå±€ */
    .card-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .card-actions {
      white-space: nowrap;
    }

    /* ---------- å·²å®Œæˆä»»åŠ¡æ ·å¼ ---------- */
    .task-completed {
      opacity: 0.5;
      color: #6b7280;
      transition: all 0.3s ease;
    }

    /* .task-completed b {
      text-decoration: line-through;
    } */
  </style>
</head>

<body>

  <h1>Rock Yu ã® ä¸ªäººç§¯åˆ†ä»»åŠ¡ç³»ç»Ÿ</h1>
  <div id="currentTime"></div>
  <div id="lastSync"></div>

  <h2>å½“å‰æ€»ç§¯åˆ†ï¼š<span id="totalPoints">0</span></h2>
  <div id="todayStats"></div>

  <div id="storageHint"></div>

  <hr>
  <hr>

  <h2>åˆ›å»ºä»»åŠ¡</h2>
  ç±»å‹ï¼š
  <label><input type="radio" name="taskType" value="daily" checked>æ¯æ—¥ä»»åŠ¡</label>
  <label><input type="radio" name="taskType" value="weekly">æ¯å‘¨ä»»åŠ¡</label>
  <label><input type="checkbox" id="taskRepeatable">å¯æ¯æ—¥å¤šæ¬¡å®Œæˆ (opt)</label><br>
  æ ‡é¢˜ï¼š<input id="taskTitle"><br>
  ç§¯åˆ† (1 ~ 100)ï¼š<input id="taskPoints" type="number" min="1" max="100" step="1" value=1><br>
  <button onclick="addTask()">æ·»åŠ ä»»åŠ¡</button>

  <hr>

  <h2>ä»»åŠ¡åˆ—è¡¨</h2>
  <div id="taskList"></div>

  <h3>ä»Šæ—¥å·²å®Œæˆä»»åŠ¡</h3>
  <ul id="todayCompleted"></ul>

  <hr>
  <hr>

  <h2>åˆ›å»ºæ¶ˆè€—é¡¹</h2>
  æ ‡é¢˜ï¼š<input id="costTitle"><br>
  æ¶ˆè€—ç§¯åˆ† (1 ~ 1000)ï¼š<input id="costPoints" type="number" min="1" max="1000" step="1" value=1><br>
  <button onclick="addCost()">æ·»åŠ æ¶ˆè€—é¡¹</button>

  <hr>

  <h2>æ¶ˆè€—é¡¹åˆ—è¡¨</h2>
  <div id="costList"></div>

  <hr>

  <h2>æ¶ˆè€—è®°å½•</h2>
  <ul id="costLog"></ul>

  <hr>
  <div>å¼€å‘ä¸­ä½¿ç”¨çš„Gisté“¾æ¥ï¼šhttps://gist.github.com/Rock3Yu/216037f52ce40fd1b08deda7e22495a0</div>
  <div>é¡¹ç›®GitHubé“¾æ¥ï¼šhttps://github.com/Rock3Yu/PointTaskSys</div>

  <script>
    /* ---------- æ•°æ® ---------- */
    const GIST_ID = "216037f52ce40fd1b08deda7e22495a0";
    let GITHUB_TOKEN = localStorage.getItem("gistToken");
    if (!GITHUB_TOKEN) {
      GITHUB_TOKEN = prompt("Enter Github Gist Token:");
      if (GITHUB_TOKEN) {
        localStorage.setItem("gistToken", GITHUB_TOKEN);
      }
    }
    const GIST_FILE = "task-data.json";
    let cloudEnabled = true;          // æ˜¯å¦å¯ç”¨äº‘åŒæ­¥
    let lastSyncTime = null;          // æœ€è¿‘ä¸€æ¬¡åŒæ­¥æ—¶é—´ï¼ˆLAï¼‰
    let saveTimer = null;             // debounce timer

    let data = JSON.parse(localStorage.getItem("taskData")) || {
      points: 0,
      tasks: [],
      costs: [],
      logs: []
    };

    function save() {
      localStorage.setItem("taskData", JSON.stringify(data));
      render();              // ç«‹åˆ»æ›´æ–° UI

      if (!cloudEnabled) return;

      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        saveToGist();
      }, 200); // 200ms debounce
    }

    /* ---------- ä»»åŠ¡ ---------- */
    function addTask() {
      if (!taskTitle.value.trim()) {
        alert("è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜");
        return;
      }

      const points = Number(taskPoints.value);
      if (!Number.isInteger(points) || points < 1 || points > 100) {
        alert("ä»»åŠ¡ç§¯åˆ†å¿…é¡»æ˜¯ 1-100 ä¹‹é—´çš„æ•´æ•°");
        return;
      }

      data.tasks.push({
        id: Date.now(),
        type: document.querySelector('input[name="taskType"]:checked')?.value,
        title: taskTitle.value,
        points: points,
        completed: false,
        repeatable: taskRepeatable.checked
      });

      taskTitle.value = "";
      taskPoints.value = "1";
      taskRepeatable.checked = false;

      save();
    }

    function toggleTask(id) {
      let t = data.tasks.find(t => t.id === id);

      if (!t.repeatable && t.completed) return;

      t.completed = true;
      data.points += t.points;
      t.completedAt = getLAISODate();

      data.logs.push({
        type: "task",
        title: t.title,
        points: t.points,
        time: t.completedAt
      });
      save();
    }

    function deleteTask(id) {
      data.tasks = data.tasks.filter(t => t.id !== id);
      save();
    }

    function getTodayStats() {
      const today = getLATodayKey();
      let earned = 0;
      let spent = 0;

      data.logs.forEach(l => {
        if (l.time.slice(0, 10) === today) {
          if (l.type === "task") earned += l.points;
          else if (l.type === "cost") spent += l.points;
        }
      });

      return { earned, spent };
    }

    /* ---------- æ¶ˆè€—é¡¹ ---------- */
    function addCost() {
      if (!costTitle.value.trim()) {
        alert("è¯·è¾“å…¥æ¶ˆè€—é¡¹æ ‡é¢˜");
        return;
      }

      const points = Number(costPoints.value);
      if (!Number.isInteger(points) || points < 1 || points > 1000) {
        alert("æ¶ˆè€—ç§¯åˆ†å¿…é¡»æ˜¯ 1-1000 ä¹‹é—´çš„æ•´æ•°");
        return;
      }

      data.costs.push({
        id: Date.now(),
        title: costTitle.value.trim(),
        points: points
      });

      costTitle.value = "";
      costPoints.value = "1";

      save();
    }

    function useCost(id) {
      let c = data.costs.find(c => c.id === id);
      if (data.points >= c.points) {
        data.points -= c.points;
        data.logs.push({
          type: "cost",
          title: c.title,
          points: c.points,
          time: getLAISODate()
        });
        save();
      } else {
        alert("ç§¯åˆ†ä¸è¶³");
      }
    }

    function deleteCost(id) {
      data.costs = data.costs.filter(c => c.id !== id);
      save();
    }

    /* ---------- æ¯æ—¥/å‘¨é‡ç½® ---------- */
    function getLAString() {
      return new Date().toLocaleString("en-US", { timeZone: "America/Los_Angeles" });
    }

    function resetIfNeeded() {
      console.log("æ£€æŸ¥æ¯æ—¥/å‘¨é‡ç½®... resetIfNeeded()");

      const todayKey = getLATodayKey();
      const lastKey = localStorage.getItem("lastDateLA") || "xxxx-xx-xx";

      if (todayKey !== lastKey) {
        // é‡ç½®æ¯æ—¥
        data.tasks.forEach(t => {
          if (t.type === "daily") t.completed = false;
        });
        console.log("å·²é‡ç½®æ¯æ—¥ä»»åŠ¡");

        const prevWeek = getWeekNumber(lastKey);
        const nowWeek = getWeekNumber(todayKey);

        if (prevWeek !== nowWeek) {
          data.tasks.forEach(t => {
            if (t.type === "weekly") t.completed = false;
          });
          console.log("å·²é‡ç½®æ¯å‘¨ä»»åŠ¡");
        }

        localStorage.setItem("lastDateLA", todayKey);
        localStorage.setItem("taskData", JSON.stringify(data));
        render();
      }
    }

    function getWeekNumber(d) {
      d = new Date(d);
      d.setHours(d.getHours() + 8); // è½¬æ¢ä¸ºLAæ—¶é—´
      d.setHours(0, 0, 0, 0);  // è®¾ç½®ä¸ºå½“å¤©çš„0ç‚¹0åˆ†0ç§’
      // è®¾ç½®ä¸ºå½“å¹´çš„ç¬¬ä¸€å¤©ï¼ˆ1æœˆ1æ—¥ï¼‰
      d.setDate(d.getDate() + 4 - (d.getDay() || 7)); // è°ƒæ•´åˆ°æœ€è¿‘çš„æ˜ŸæœŸä¸€
      var yearStart = new Date(d.getFullYear(), 0, 1);
      // è®¡ç®—å¤©æ•°å·®
      var dayDiff = (d - yearStart) / 86400000; // 24 * 60 * 60 * 1000
      return Math.ceil((dayDiff + 1) / 7);
    }

    function getLAISODate() {
      const now = new Date();
      return String(now.getFullYear()).padStart(4, "0") + "-" +
        String(now.getMonth() + 1).padStart(2, "0") + "-" +
        String(now.getDate()).padStart(2, "0") + "T" +
        String(now.getHours()).padStart(2, "0") + ":" +
        String(now.getMinutes()).padStart(2, "0") + ":" +
        String(now.getSeconds()).padStart(2, "0");
    }

    function getLATodayKey() {
      return getLAISODate().slice(0, 10); // YYYY-MM-DD
    }

    function getLADisplayTime() {
      return new Date().toLocaleString("en-US", {
        timeZone: "America/Los_Angeles"
      });
    }

    function startClock() {
      function tick() {
        currentTime.innerText =
          `å½“å‰æ—¶é—´ï¼ˆLAï¼‰ï¼š${getLADisplayTime()}`;
      }
      tick(); // ç«‹å³æ˜¾ç¤ºä¸€æ¬¡
      setInterval(tick, 1000);
    }

    /* ---------- æ¸²æŸ“ ---------- */
    function render() {
      totalPoints.innerText = data.points;

      storageHint.innerText = cloudEnabled
        ? "äº‘åŒæ­¥å¯ç”¨ä¸­"
        : "æœ¬åœ°å­˜å‚¨ç‰ˆæœ¬å¯ç”¨ä¸­";

      taskList.innerHTML = "";
      data.tasks
        .sort((a, b) => {
          // å…ˆæŒ‰ç±»å‹æ’ daily åœ¨å‰
          if (a.type !== b.type) {
            return a.type === "daily" ? -1 : 1;
          }
          // å†æŒ‰ title å­—æ¯åº
          return a.title.localeCompare(b.title);
        })
        .forEach(t => {
          let div = document.createElement("div");
          // div.className = t.completed ? "task-completed" : "";
          div.className = t.completed && !t.repeatable ? "task-completed" : "";
          div.innerHTML = `
            <div class="card-row">
              <div>
                [${t.type}]
                ${t.repeatable ? "ğŸ”" : ""}
                <b>${t.title}</b> (${t.points}åˆ†)
                ${t.completed ? "âœ…" : ""}
              </div>
              <div class="card-actions">
                <button onclick="toggleTask(${t.id})">å®Œæˆ</button>
                <button onclick="deleteTask(${t.id})">åˆ é™¤</button>
              </div>
            </div>
          `;
          taskList.appendChild(div);
        });

      costList.innerHTML = "";
      data.costs
        .sort((a, b) => a.title.localeCompare(b.title))
        .forEach(c => {
          let div = document.createElement("div");
          div.innerHTML = `
            <div class="card-row">
              <div>
                <b>${c.title}</b>ï¼ˆ${c.points}åˆ†ï¼‰
              </div>
              <div class="card-actions">
                <button onclick="useCost(${c.id})">ä½¿ç”¨</button>
                <button onclick="deleteCost(${c.id})">åˆ é™¤</button>
              </div>
            </div>
          `;
          costList.appendChild(div);
        });

      costLog.innerHTML = "";
      data.logs
        .forEach(l => {
          if (l.type === "cost") {
            let li = document.createElement("li");
            const displayTime = new Date(l.time).toLocaleString("en-US", {
              timeZone: "America/Los_Angeles"
            });
            li.innerText = `${displayTime} - ${l.title} (-${l.points})`;
            costLog.appendChild(li);
          }
        });

      todayCompleted.innerHTML = "";
      const today = getLATodayKey();
      data.logs
        .forEach(l => {
          if (l.type === "task" && l.time.slice(0, 10) === today) {
            const li = document.createElement("li");
            li.innerText = `${l.title} (+${l.points})`;
            todayCompleted.appendChild(li);
          }
        });

      const stats = getTodayStats();
      todayStats.innerText =
        `ä»Šæ—¥è·å¾—ï¼š+${stats.earned} | ä»Šæ—¥æ¶ˆè€—ï¼š-${stats.spent}`;

      lastSync.innerText = lastSyncTime
        ? `æœ€è¿‘åŒæ­¥æ—¶é—´ï¼ˆLAï¼‰ï¼š${lastSyncTime}`
        : "å°šæœªåŒæ­¥";
    }

    function updateLastSync() {
      lastSyncTime = getLAString();
      localStorage.setItem("lastSyncTime", lastSyncTime);
      render();
    }

    /* ---------- Cloud Saving ---------- */
    async function loadFromGist() {
      try {
        const res = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
          headers: {
            "Authorization": `Bearer ${GITHUB_TOKEN}`
          }
        });

        if (!res.ok) throw new Error("Token invalid");

        const gist = await res.json();
        const content = gist.files[GIST_FILE].content;

        data = JSON.parse(content);
        localStorage.setItem("taskData", JSON.stringify(data));

        cloudEnabled = true;
        updateLastSync();

      } catch (e) {
        console.warn("äº‘åŒæ­¥ä¸å¯ç”¨ï¼Œå¯ç”¨æœ¬åœ°å­˜å‚¨", e);
        cloudEnabled = false;
      }
    }

    async function saveToGist() {
      if (!cloudEnabled) return;
      try {
        const res = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
          method: "PATCH",
          headers: {
            "Authorization": `Bearer ${GITHUB_TOKEN}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            files: {
              [GIST_FILE]: {
                content: JSON.stringify(data, null, 2)
              }
            }
          })
        });

        if (!res.ok) throw new Error("Sync failed");

        updateLastSync();

      } catch (e) {
        console.error("äº‘åŒæ­¥å¤±è´¥ï¼Œåˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼", e);
        cloudEnabled = false;
        render();
      }
    }

    (async function init() {
      try {
        await loadFromGist();
      } catch (e) {
        console.warn("ä½¿ç”¨æœ¬åœ°æ•°æ®");
      }
      resetIfNeeded();
      lastSyncTime = localStorage.getItem("lastSyncTime");
      render();
      startClock();
    })();
  </script>

</body>

</html>
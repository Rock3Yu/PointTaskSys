<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>个人积分任务系统</title>

  <style>
    html {
      font-size: 24px;
    }

    @media (max-width: 480px) {
      html {
        font-size: 24px;
      }
    }

    /* ---------- 基础 ---------- */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f4f9ff;
      color: #1f2937;
      margin: 0;
      padding: 16px;
      line-height: 1.6;
    }

    h1,
    h2,
    h3 {
      margin-top: 24px;
      margin-bottom: 12px;
      color: #0f4c81;
    }

    h1 {
      font-size: 1.6rem;
      text-align: center;
    }

    h2 {
      font-size: 1.25rem;
    }

    h3 {
      font-size: 1.1rem;
    }

    hr {
      border: none;
      border-top: 1px solid #dbeafe;
      margin: 20px 0;
    }

    /* ---------- 信息提示 ---------- */
    #currentTime,
    #lastSync,
    #storageHint,
    #todayStats {
      font-size: 0.95rem;
      color: #2563eb;
      margin-top: 6px;
    }

    #storageHint {
      font-size: 0.85rem;
      color: #64748b;
    }

    /* ---------- 输入 ---------- */
    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      margin-bottom: 10px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #c7d2fe;
      box-sizing: border-box;
    }

    input[type="radio"] {
      transform: scale(1.2);
      margin-right: 4px;
    }

    label {
      margin-right: 12px;
    }

    /* ---------- 按钮 ---------- */
    button {
      padding: 8px 14px;
      margin: 6px 4px 6px 0;
      font-size: 0.95rem;
      border-radius: 8px;
      border: none;
      background: #3b82f6;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background: #2563eb;
    }

    button:active {
      transform: scale(0.97);
    }

    /* ---------- 列表卡片 ---------- */
    #taskList>div,
    #costList>div {
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    /* ---------- 已完成任务 ---------- */
    #todayCompleted li {
      background: #e0f2fe;
      padding: 6px 10px;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 0.9rem;
    }

    /* ---------- 消耗记录 ---------- */
    #costLog li {
      font-size: 0.9rem;
      color: #475569;
      margin-bottom: 6px;
    }

    /* ---------- 响应式 ---------- */
    @media (min-width: 768px) {
      body {
        max-width: 700px;
        margin: auto;
        padding: 24px;
      }
    }

    /* ---------- 创建区域输入行优化 ---------- */
    h2+label,
    h2+input {
      display: inline-block;
    }

    /* 标题输入框更长 */
    /* #taskTitle,
    #costTitle {
      width: 80%;
    }
      */

    /* 积分行：文字 + 输入在同一行 */
    #taskPoints,
    #costPoints {
      width: 120px;
      display: inline-block;
      margin-left: 8px;
    }

    /* 积分所在行整体不要撑满 */
    #taskPoints,
    #costPoints {
      margin-bottom: 6px;
    }

    /* ---------- 统一输入框高度 ---------- */
    input[type="text"],
    input[type="number"] {
      height: 44px;
      line-height: 44px;
      padding: 0 12px;
    }
  </style>
</head>

<body>

  <h1>Rock Yu の 个人积分任务系统</h1>
  <div id="currentTime"></div>
  <div id="lastSync"></div>

  <h2>当前总积分：<span id="totalPoints">0</span></h2>
  <div id="todayStats"></div>

  <div id="storageHint"></div>

  <hr>
  <hr>

  <h2>创建任务</h2>
  类型：
  <label><input type="radio" name="taskType" value="daily" checked>每日任务</label>
  <label><input type="radio" name="taskType" value="weekly">每周任务</label><br>
  标题：<input id="taskTitle"><br>
  积分 (0 ~ 100)：<input id="taskPoints" type="number" min="0" max="100" step="1"><br>
  <button onclick="addTask()">添加任务</button>

  <hr>

  <h2>任务列表</h2>
  <div id="taskList"></div>

  <h3>今日已完成任务</h3>
  <ul id="todayCompleted"></ul>

  <hr>
  <hr>

  <h2>创建消耗项</h2>
  标题：<input id="costTitle"><br>
  消耗积分 (1 ~ 1000)：<input id="costPoints" type="number" min="1" max="1000" step="1"><br>
  <button onclick="addCost()">添加消耗项</button>

  <hr>

  <h2>消耗项列表</h2>
  <div id="costList"></div>

  <hr>

  <h2>消耗记录</h2>
  <ul id="costLog"></ul>

  <hr>
  <div>开发中使用的Gist链接：https://gist.github.com/Rock3Yu/216037f52ce40fd1b08deda7e22495a0</div>

  <script>
    /* ---------- 数据 ---------- */
    const GIST_ID = "216037f52ce40fd1b08deda7e22495a0";
    let GITHUB_TOKEN = localStorage.getItem("gistToken");
    if (!GITHUB_TOKEN) {
      GITHUB_TOKEN = prompt("Enter Github Gist Token:");
      if (GITHUB_TOKEN) {
        localStorage.setItem("gistToken", GITHUB_TOKEN);
      }
    }
    const GIST_FILE = "task-data.json";
    let cloudEnabled = true;          // 是否启用云同步
    let lastSyncTime = null;          // 最近一次同步时间（LA）
    let saveTimer = null;             // debounce timer

    let data = JSON.parse(localStorage.getItem("taskData")) || {
      points: 0,
      tasks: [],
      costs: [],
      logs: []
    };

    function save() {
      localStorage.setItem("taskData", JSON.stringify(data));
      render();              // 立刻更新 UI

      if (!cloudEnabled) return;

      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        saveToGist();
      }, 200); // 200ms debounce
    }

    /* ---------- 任务 ---------- */
    function addTask() {
      if (!taskTitle.value.trim()) {
        alert("请输入任务标题");
        return;
      }

      const points = Number(taskPoints.value);
      if (!Number.isInteger(points) || points < 0 || points > 100) {
        alert("任务积分必须是 0-100 之间的整数");
        return;
      }

      data.tasks.push({
        id: Date.now(),
        type: document.querySelector('input[name="taskType"]:checked')?.value,
        title: taskTitle.value,
        points: points,
        completed: false
      });

      taskTitle.value = "";
      taskPoints.value = "";

      save();
    }

    function toggleTask(id) {
      let t = data.tasks.find(t => t.id === id);
      if (!t.completed) {
        data.points += t.points;
        t.completed = true;
        t.completedAt = getLAISODate();

        data.logs.push({
          type: "task",
          title: t.title,
          points: t.points,
          time: t.completedAt
        });
      }
      save();
    }

    function deleteTask(id) {
      data.tasks = data.tasks.filter(t => t.id !== id);
      save();
    }

    function getTodayStats() {
      const today = getLATodayKey();
      let earned = 0;
      let spent = 0;

      data.logs.forEach(l => {
        if (l.time.slice(0, 10) === today) {
          if (l.type === "task") earned += l.points;
          else if (l.type === "cost") spent += l.points;
        }
      });

      return { earned, spent };
    }

    /* ---------- 消耗项 ---------- */
    function addCost() {
      if (!costTitle.value.trim()) {
        alert("请输入消耗项标题");
        return;
      }

      const points = Number(costPoints.value);
      if (!Number.isInteger(points) || points < 1 || points > 1000) {
        alert("消耗积分必须是 1-1000 之间的整数");
        return;
      }

      data.costs.push({
        id: Date.now(),
        title: costTitle.value.trim(),
        points: points
      });

      costTitle.value = "";
      costPoints.value = "";

      save();
    }

    function useCost(id) {
      let c = data.costs.find(c => c.id === id);
      if (data.points >= c.points) {
        data.points -= c.points;
        data.logs.push({
          type: "cost",
          title: c.title,
          points: c.points,
          time: getLAISODate()
        });
        save();
      } else {
        alert("积分不足");
      }
    }

    function deleteCost(id) {
      data.costs = data.costs.filter(c => c.id !== id);
      save();
    }

    /* ---------- 每日/周重置 ---------- */
    function getLAString() {
      return new Date().toLocaleString("en-US", { timeZone: "America/Los_Angeles" });
    }

    function resetIfNeeded() {
      const now = new Date(getLAString());
      const todayKey = now.toISOString().slice(0, 10); // YYYY-MM-DD

      const lastKey = localStorage.getItem("lastDateLA");

      // 如果是新的一天
      if (todayKey !== lastKey) {
        // 每日任务全部 false
        data.tasks.forEach(t => {
          if (t.type === "daily") {
            t.completed = false;
          }
        });

        // 是新的一周吗？简单按 周日为一周起点
        if (lastKey) {
          const prev = new Date(localStorage.getItem("lastDateLA"));
          const prevWeek = getWeekNum(prev);
          const nowWeek = getWeekNum(now);

          if (prevWeek !== nowWeek) {
            // 新的一周：weekly 全 false
            data.tasks.forEach(t => {
              if (t.type === "weekly") {
                t.completed = false;
              }
            });
          }
        }

        localStorage.setItem("lastDateLA", todayKey);
        localStorage.setItem("taskData", JSON.stringify(data));
        render();
      }
    }

    function getWeekNum(d) {
      // ISO 周数
      const date = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const day = date.getDay() || 7;
      date.setDate(date.getDate() + 4 - day);
      const yearStart = new Date(date.getFullYear(), 0, 1);
      return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
    }

    function getLAISODate() {
      return new Date(
        new Date().toLocaleString("en-US", { timeZone: "America/Los_Angeles" })
      ).toISOString(); // 2026-01-12T17:34:21.000Z
    }

    function getLATodayKey() {
      return getLAISODate().slice(0, 10); // YYYY-MM-DD
    }

    function getLADisplayTime() {
      return new Date().toLocaleString("en-US", {
        timeZone: "America/Los_Angeles"
      });
    }

    function startClock() {
      function tick() {
        currentTime.innerText =
          `当前时间（LA）：${getLADisplayTime()}`;
      }
      tick(); // 立即显示一次
      setInterval(tick, 1000);
    }

    /* ---------- 渲染 ---------- */
    function render() {
      totalPoints.innerText = data.points;

      storageHint.innerText = cloudEnabled
        ? "云同步启用中"
        : "本地存储版本启用中";

      taskList.innerHTML = "";
      data.tasks
        .sort((a, b) => {
          // 先按类型排 daily 在前
          if (a.type !== b.type) {
            return a.type === "daily" ? -1 : 1;
          }
          // 再按 title 字母序
          return a.title.localeCompare(b.title);
        })
        .forEach(t => {
          let div = document.createElement("div");
          div.innerHTML = `
      [${t.type}] 
      <b>${t.title}</b> (${t.points}分) 
      ${t.completed ? "✔" : ""}
      <button onclick="toggleTask(${t.id})">完成</button>
      <button onclick="deleteTask(${t.id})">删除</button>
    `;
          taskList.appendChild(div);
        });

      costList.innerHTML = "";
      data.costs.forEach(c => {
        let div = document.createElement("div");
        div.innerHTML = `
      <b>${c.title}</b>（${c.points}分）
      <button onclick="useCost(${c.id})">使用</button>
      <button onclick="deleteCost(${c.id})">删除</button>
    `;
        costList.appendChild(div);
      });

      costLog.innerHTML = "";
      data.logs.forEach(l => {
        if (l.type === "cost") {
          let li = document.createElement("li");
          const displayTime = new Date(l.time).toLocaleString("en-US", {
            timeZone: "America/Los_Angeles"
          });
          li.innerText = `${displayTime} - ${l.title} (-${l.points})`;
          costLog.appendChild(li);
        }
      });

      todayCompleted.innerHTML = "";
      const today = getLATodayKey();
      data.logs.forEach(l => {
        if (l.type === "task" && l.time.slice(0, 10) === today) {
          const li = document.createElement("li");
          li.innerText = `${l.title} (+${l.points})`;
          todayCompleted.appendChild(li);
        }
      });

      const stats = getTodayStats();
      todayStats.innerText =
        `今日获得：+${stats.earned} | 今日消耗：-${stats.spent}`;

      lastSync.innerText = lastSyncTime
        ? `最近同步时间（LA）：${lastSyncTime}`
        : "尚未同步";
    }

    function updateLastSync() {
      lastSyncTime = getLAString();
      localStorage.setItem("lastSyncTime", lastSyncTime);
      render();
    }

    /* ---------- Cloud Saving ---------- */
    async function loadFromGist() {
      try {
        const res = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
          headers: {
            "Authorization": `Bearer ${GITHUB_TOKEN}`
          }
        });

        if (!res.ok) throw new Error("Token invalid");

        const gist = await res.json();
        const content = gist.files[GIST_FILE].content;

        data = JSON.parse(content);
        localStorage.setItem("taskData", JSON.stringify(data));

        cloudEnabled = true;
        updateLastSync();

      } catch (e) {
        console.warn("云同步不可用，启用本地存储", e);
        cloudEnabled = false;
      }
    }

    async function saveToGist() {
      if (!cloudEnabled) return;
      try {
        const res = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
          method: "PATCH",
          headers: {
            "Authorization": `Bearer ${GITHUB_TOKEN}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            files: {
              [GIST_FILE]: {
                content: JSON.stringify(data, null, 2)
              }
            }
          })
        });

        if (!res.ok) throw new Error("Sync failed");

        updateLastSync();

      } catch (e) {
        console.error("云同步失败，切换到本地模式", e);
        cloudEnabled = false;
        render();
      }
    }

    (async function init() {
      try {
        await loadFromGist();
      } catch (e) {
        console.warn("使用本地数据");
      }
      resetIfNeeded();
      lastSyncTime = localStorage.getItem("lastSyncTime");
      render();
      startClock();
    })();
  </script>

</body>

</html>